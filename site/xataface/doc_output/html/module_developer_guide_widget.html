<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Xataface: Creating Custom Widgets</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="xataface-logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Xataface
   &#160;<span id="projectnumber">2.0alpha2</span>
   </div>
   <div id="projectbrief">Xataface Application Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Creating Custom Widgets </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>return to <a class="el" href="module_developer_guide.html">Module Developer's Guide</a></li>
<li>Back to <a class="el" href="module_developer_guide_css.html">Adding Custom CSS Files</a></li>
<li>Next <a class="el" href="module_developer_guide_withdata.html">Module-Associated Data</a></li>
</ul>
<dl class="section user"><dt>Contents of this Section:</dt><dd><ol type="1">
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step1">Step 1: Create a Widget Handler</a></li>
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step2">Step 2: Register the Widget Handler</a></li>
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step3">Step 3: Use The Widget For a Field</a></li>
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step4">Step 4: Add Javascripts and CSS Files</a></li>
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step5">Step 5: Creating a Javascript Bootstrap For the Widget</a></li>
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step6">Step 6: Registering the Javascript Bootstrap</a></li>
<li><a class="el" href="module_developer_guide_widget.html#module_developer_guide_widget_step7">Step 7: Trying Out Our Widget</a></li>
</ol>
</dd></dl>
<p>The previous sections have been laying the foundation for this section, in what will be our first "useful" module. Xataface comes with a set of built-in widgets that are quite useful, but once in a while, you will likely find yourself in need of a widget that doesn't yet exist. The internet is full of jQuery plugins that can easily be converted into Xataface widgets with very little effort.</p>
<p>Some Javascript plugins that have already been adapted into Xataface widgets include:</p>
<ul>
<li><a href="http://xataface.com/dox/modules/ckeditor/latest/">CKeditor</a></li>
<li><a href="http://xataface.com/dox/modules/datepicker/latest/">Datepicker</a></li>
<li><a href="http://xataface.com/dox/modules/depselect/latest/">Depselect</a></li>
<li><a href="http://xataface.com/dox/modules/tagger/latest/">Tagger</a></li>
</ul>
<h1><a class="anchor" id="module_developer_guide_widget_strategy"></a>
The Strategy</h1>
<p>The general strategy for creating a widget is:</p>
<ol type="1">
<li>Add CSS classes and HTML attributes to a simple text input so that we can access all necessary information from javascript</li>
<li>Transform text inputs matching the given attributes or CSS classes into more complex widgets using Javascript.</li>
</ol>
<p>For this tutorial we will be creating a Color Picker widget based on the <a href="http://www.eyecon.ro/colorpicker/">eyecon colorpicker</a>.</p>
<h1><a class="anchor" id="module_developer_guide_widget_step1"></a>
Step 1: Create a Widget Handler</h1>
<p>Xataface forms are based on HTML_QuickForm for its base set of widgets, but it uses a Widget Handler as a wrapper around these widgets as a means of configuring them. These wrappers are known as Widget handlers and they are managed by the <a class="el" href="class_dataface___form_tool.html">Dataface_FormTool</a> class.</p>
<p>A widget handler has to be able to do at least three things:</p>
<ol type="1">
<li>Build a widget (returning an <a href="http://pear.php.net/package/HTML_QuickForm/docs/3.2.13/HTML_QuickForm/HTML_QuickForm_element.html">HTML_QuickForm_element</a> object.)</li>
<li>Retrieve a value stored in the widget.</li>
<li>Store a value in the widget.</li>
</ol>
<p>In most cases you can get by with only defining a single method (buildWidget()) in the widget handler and let Xataface just use its default handler to load and store the values in the widget.</p>
<dl class="section user"><dt>Creating the Widget Handler Script</dt><dd></dd></dl>
<p>There is no set place where the widget handler needs to go. Let's just add it to the root directory of our module, and call it <code>colorpicker_widget.php</code>. Add the following content to this file:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Dataface_FormTool_colorpicker {</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Builds a widget for the given record</span></div>
<div class="line">        <span class="keyword">function</span> buildWidget($record, &amp;<a class="code" href="blob_8php.html#a83e4d6721f3491a4fd780dbd3ce1a3c0">$field</a>, $form, $formFieldName, $new=<span class="keyword">false</span>){</div>
<div class="line">                </div>
<div class="line">            <span class="comment">// Obtain an HTML_QuickForm factory to creat the basic elements</span></div>
<div class="line">            $factory = <a class="code" href="class_dataface___form_tool.html#a47f02f15b11d4491e056298910e4204a" title="Returns a QuickForm object that can be used to generate elements safely.">Dataface_FormTool::factory</a>();</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Create a basic text field</span></div>
<div class="line">            $el = $factory-&gt;addElement(<span class="stringliteral">&#39;text&#39;</span>, $formFieldName, $widget[<span class="stringliteral">&#39;label&#39;</span>]);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">return</span> $el;</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section see"><dt>See Also</dt><dd><a class="el" href="interface_widget_handler.html#a04cd107b4dd1798351f535c97af61b0e" title="Creates a widget for a specific field on a form.">WidgetHandler::buildWidget()</a> for details of the parameters of this method and how they should be used.</dd></dl>
<p>The above widget handler doesn't do anything fancy yet. It simply creates a plain text field. After we have our widget working as a plain text field, we'll go back and transform it into a color picker.</p>
<dl class="section attention"><dt>Attention</dt><dd>I chose to base this widget on the 'text' widget because text widgets are easy to work with. If your widget will be storing multiple lines of data, you should use a textarea widget as a base instead to prevent data from being clipped inadvertently. In our case we are only storing colors though so a text widget makes sense as a base to build upon.</dd></dl>
<h1><a class="anchor" id="module_developer_guide_widget_step2"></a>
Step 2: Register the Widget Handler</h1>
<p>Before we can use our new widget, we need to register the widget handler with the form tool. We'll make use of the <code>Dataface_FormTool::init</code> event that is fired when the form tool is first created. This allows us to avoid loading the FormTool into memory unnecessarily. We'll do all of this in our module class's constructor as this is guraranteed to be executed at the beginning of every request that the module is enabled for.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>modules_hello_world {</div>
<div class="line"></div>
<div class="line">    <span class="comment">// The constructor for the module class.  Executed at the beginning</span></div>
<div class="line">    <span class="comment">// of each request</span></div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> __construct(){</div>
<div class="line">        </div>
<div class="line">        <a class="code" href="blob_8php.html#adfb117f244076aa9bc269269f7e57403">$app</a> = <a class="code" href="class_dataface___application.html#a9eb606fdb589cab3ae9edc96dce15972" title="Returns reference to the singleton instance of this class.">Dataface_Application::getInstance</a>();</div>
<div class="line">        </div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">if</span> ( !class_exists(<span class="stringliteral">&#39;Dataface_FormTool&#39;</span>) ){</div>
<div class="line">                <span class="comment">// If the formtool is not loaded then we don&#39;t </span></div>
<div class="line">                <span class="comment">// want to load it here... we&#39;ll just register</span></div>
<div class="line">                <span class="comment">// the _registerWidget() method to run  as soon</span></div>
<div class="line">                <span class="comment">// as the FormTool is loaded.</span></div>
<div class="line">                        <a class="code" href="blob_8php.html#adfb117f244076aa9bc269269f7e57403">$app</a>-&gt;registerEventListener(</div>
<div class="line">                                <span class="stringliteral">&#39;Dataface_FormTool::init&#39;</span>, </div>
<div class="line">                                array($this, <span class="stringliteral">&#39;_registerWidget&#39;</span>)</div>
<div class="line">                        );</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                        <span class="comment">// If the formTool is already loaded, then we&#39;ll</span></div>
<div class="line">                        <span class="comment">// register the widget directly</span></div>
<div class="line">                        $this-&gt;_registerWidget(<a class="code" href="class_dataface___form_tool.html#a940c46dff92c1704a1d43d2926a72ba0" title="Singleton method for obtaining a reference to the Dataface_FormTool object.">Dataface_FormTool::getInstance</a>());</div>
<div class="line">                }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Function to register our widget with the form tool.</span></div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> _registerWidget(<a class="code" href="class_dataface___form_tool.html" title="A class encapsulating the most common form building and processing functions in dataface.">Dataface_FormTool</a> $formTool){</div>
<div class="line">        $formTool-&gt;<a class="code" href="class_dataface___form_tool.html#af6c31f1f026f1a025877fbfec4ba896a" title="Registers a class to handle the pushing and pulling for a particular type of widget. This is the mechanism by which custom widgets can be created and registered. All that is required is to define a WidgetHandler and then register that handler with the form tool with this method.">registerWidgetHandler</a>(</div>
<div class="line">            <span class="stringliteral">&#39;colorpicker&#39;</span>, </div>
<div class="line">            dirname(__FILE__).<span class="stringliteral">&#39;/colorpicker_widget.php&#39;</span>,</div>
<div class="line">            <span class="stringliteral">&#39;Dataface_FormTool_colorpicker&#39;</span></div>
<div class="line">        );</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="module_developer_guide_widget_step3"></a>
Step 3: Use The Widget For a Field</h1>
<p>Now that we have registered our widget, we should be able to use the widget. Let's set up a simple table in the database for this purpose: </p>
<div class="fragment"><div class="line">create table color_profile (</div>
<div class="line">    profile_id <span class="keywordtype">int</span>(11) not null auto_increment primary key,</div>
<div class="line">    profile_name varchar(32),</div>
<div class="line">    foreground_color varchar(32),</div>
<div class="line">    background_color varchar(32)</div>
<div class="line">)</div>
</div><!-- fragment --><p>And we'll create a fields.ini file for this table in the <code>myapp</code> directory: </p>
<div class="fragment"><div class="line">myapp/tables/color_profile/fields.ini</div>
</div><!-- fragment --><p>We will use our new colorpicker widget as the widget for both the <code>foreground_color</code> and <code>background_color</code> fields: </p>
<div class="fragment"><div class="line">[foreground_color]</div>
<div class="line">    widget:type=colorpicker</div>
<div class="line">    </div>
<div class="line">[background_color]</div>
<div class="line">    widget:type=colorpicker</div>
</div><!-- fragment --><dl class="section user"><dt>Try Out Our Widgets</dt><dd></dd></dl>
<p>Now that all of the pieces are in place, let's load up a new record form for the <code>color_profile</code> table and see what it looks like.</p>
<dl class="section note"><dt>Note</dt><dd>You can load the new record form for the <code>color_profile</code> table by pointing your web browser to your application's index.php page with the GET parameters <code>-table=color_profile</code> and <code>-action=new</code> </dd></dl>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-29_at_11.57.54_AM.png?max_width=640" />
</div>
<p>If everything is working correctly, you should see regular text fields for the <code>foreground_color</code> and <code>background_color</code> fields. This may be slightly disappointing, but this is what we want. We'll convert these into more interactive color-picker widgets in the next few steps. At this point we just want to be sure that our custom widget handler is working.</p>
<dl class="section attention"><dt>Attention</dt><dd>If you do not see a form like the one above but instead see an error message, you'll need to go back through your code to make sure that there are no typos... Get this working before moving onto the next steps.</dd></dl>
<h1><a class="anchor" id="module_developer_guide_widget_step4"></a>
Step 4: Add Javascripts and CSS Files</h1>
<p>Before we can convert our text fields into color pickers, we need to make sure that the javascripts, CSS files, and images for the colorpicker widget that we are planning to use are accessible to our project. Specifically we need to add these files to our project in such a way that the <a class="el" href="class_dataface___javascript_tool.html" title="A Class that manages, builds, and maintains dependencies of javacripts.">Dataface_JavascriptTool</a> and <a class="el" href="class_dataface___c_s_s_tool.html">Dataface_CSSTool</a> can work with them.</p>
<dl class="section user"><dt>Downloading The Color Picker Files</dt><dd></dd></dl>
<p>We start by downloading the Color Picker source files from the <a href="http://www.eyecon.ro/colorpicker/#download">EyeCon</a> website. After unzipping the ZIP file we should have the following directory structure:</p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-29_at_12.14.44_PM.png?max_width=640" />
</div>
<p>So we have 3 types of content to contend with:</p>
<ol type="1">
<li>CSS Files</li>
<li>Images</li>
<li>Javascript Files</li>
</ol>
<dl class="section attention"><dt>Attention</dt><dd>If possible it is important to keep all images in the same place relative to the CSS files or some of the path dependencies may be broken at runtime. Alternatively you can go through the CSS files to alter the paths to all referenced images to mark the new location.</dd></dl>
<dl class="section user"><dt>Adding the Javascript Files To Our Module</dt><dd></dd></dl>
<p>The first thing we'll do is to add the Javascript files to our module. In order to keep things separated, we'll place them inside our namespace inside the js directory. A good location might be </p>
<div class="fragment"><div class="line">js/xataface/modules/hello_world/colorpicker</div>
</div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd>We will copy all of the javascript files except <code>jquery.js</code> because we have our own version of jQuery with the Xataface distribution that we'll be using instead.</dd></dl>
<p>Once we have copied all of the javascript files we should have the following directory structure inside our module:</p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-29_at_12.24.08_PM.png?max_width=640" />
</div>
<dl class="section user"><dt>Adding the CSS Files and Images To Our Module</dt><dd></dd></dl>
<p>Similarly, we'll add the CSS files in a namespaced directory structure so that we can reference them uniquely. We'll place both the <code>css</code> and <code>images</code> directories inside the </p>
<div class="fragment"><div class="line">css/xataface/modules/hello_world/colorpicker</div>
</div><!-- fragment --><p> directory.</p>
<p>When we're done copying these files, the directory structure of our module will look like:</p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-29_at_12.27.53_PM.png?max_width=640" />
</div>
<h1><a class="anchor" id="module_developer_guide_widget_step5"></a>
Step 5: Creating a Javascript Bootstrap For the Widget</h1>
<p>Now that we've added all of the necessary javascript and CSS files for the colorpicker widget, we need to create our own thin bootstrap code that converts our text fields into color pickers.</p>
<p>Before we can do this, however, we need to add a CSS class or attribute to our text fields so that we are able to identify the colorpicker widgets in Javascript. We modify our Widget handler (<code>colorpicker_widget.php</code>) in order to accommodate this:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Dataface_FormTool_colorpicker {</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Builds a widget for the given record</span></div>
<div class="line">        <span class="keyword">function</span> buildWidget($record, &amp;<a class="code" href="blob_8php.html#a83e4d6721f3491a4fd780dbd3ce1a3c0">$field</a>, $form, $formFieldName, $new=<span class="keyword">false</span>){</div>
<div class="line">                </div>
<div class="line">            <span class="comment">// Obtain an HTML_QuickForm factory to creat the basic elements</span></div>
<div class="line">            $factory = <a class="code" href="class_dataface___form_tool.html#a47f02f15b11d4491e056298910e4204a" title="Returns a QuickForm object that can be used to generate elements safely.">Dataface_FormTool::factory</a>();</div>
<div class="line">            </div>
<div class="line">            $atts = array(</div>
<div class="line">                <span class="stringliteral">&#39;class&#39;</span> =&gt; <span class="stringliteral">&#39;xf-colorpicker&#39;</span></div>
<div class="line">            );</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Create a basic text field</span></div>
<div class="line">            $el = $factory-&gt;addElement(<span class="stringliteral">&#39;text&#39;</span>, $formFieldName, $widget[<span class="stringliteral">&#39;label&#39;</span>], $atts);</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">return</span> $el;</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p>All we've done here is create an <code>$atts</code> array where we specify a <code>class</code> attribute that is to be added to all color picker fields. We then add this as the 4th parameter of the <code>$factory-&gt;addElement()</code> call (a call to HTML_QuickForm::addElement).</p>
<p>In short, all this does is add the css class <code>xf-colorpicker</code> to all instances of our colorpicker widget. This will allow our Javascript bootstrap code that we're about to write to identify which fields are colorpicker fields, and hence which ones should be "decorated".</p>
<p>We'll place our Javascript bootstrap code into a new file. It's location doesn't matter as long as it is located somewhere inside the module's <code>js</code> directory. We'll place it at </p>
<div class="fragment"><div class="line">js/xataface/modules/hello_world/colorpicker_widget.js</div>
</div><!-- fragment --><p>Place the following code inside this file: </p>
<div class="fragment"><div class="line"><span class="comment">//require &lt;jquery.packed.js&gt;</span></div>
<div class="line"><span class="comment">//require &lt;xataface/modules/hello_world/colorpicker/colorpicker.js&gt;</span></div>
<div class="line"><span class="comment">//require-css &lt;xataface/modules/hello_world/colorpicker/css/colorpicker.css&gt;</span></div>
<div class="line">(<span class="keyword">function</span>(){</div>
<div class="line">    var $ = jQuery;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// We wrap our code in registerXatafaceDecorator so that it is executed</span></div>
<div class="line">    <span class="comment">// whenever new content is added to the page.  This is important if you</span></div>
<div class="line">    <span class="comment">// want your widget to work in compound widgets like the grid widget.</span></div>
<div class="line">    registerXatafaceDecorator(<span class="keyword">function</span>(node){</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Find all elements with the xf-colorpicker CSS class</span></div>
<div class="line">        <span class="comment">// and convert them into a ColorPicker()</span></div>
<div class="line">        $(<span class="stringliteral">&#39;input.xf-colorpicker&#39;</span>, node).ColorPicker({</div>
<div class="line">            onSubmit: <span class="keyword">function</span>(hsb, hex, rgb, el) {</div>
<div class="line">                        $(el).val(hex);</div>
<div class="line">                        $(el).ColorPickerHide();</div>
<div class="line">                },</div>
<div class="line">                onBeforeShow: <span class="keyword">function</span> () {</div>
<div class="line">                        $(<span class="keyword">this</span>).ColorPickerSetColor(this.value);</div>
<div class="line">                }</div>
<div class="line">            });</div>
<div class="line">        </div>
<div class="line">    });</div>
<div class="line"></div>
<div class="line">})();</div>
</div><!-- fragment --><p>There isn't much in ths bootstrap file, but there's a lot going on.</p>
<ol type="1">
<li>The first three lines declare the other javascript and CSS files that should be included. This is where we include jQuery and the ColorPicker javascript and CSS files that we just installed in the last step.</li>
<li>We wrap the whole thing inside an anonymous Javascript function to ensure that we don't pollute the global namespace with our code.</li>
<li>We wrap our "decoration" code inside the <code>registerXatafaceDecorator</code> function so that it will be executed for any part of the page that is added even after page load. This is important if you want your widget to work properly inside compound widgets like the grid widget.</li>
<li>We apply the <code>ColorPicker()</code> jQuery plugin to all elements with the <code>xf-colorpicker</code> CSS class.</li>
</ol>
<h1><a class="anchor" id="module_developer_guide_widget_step6"></a>
Step 6: Registering the Javascript Bootstrap</h1>
<p>Now that we have created the Javascript bootstrap we need a way to ensure that it will be run whenever a form is rendered. Essentially, this just requires us to import the <code>colorpickier_widget.js</code> using <a class="el" href="class_dataface___javascript_tool.html#a8e54c10e39f413e6623e7f56a2e4f166">Dataface_JavascriptTool::import()</a>, but we would prefer to do this in the most efficient way possible, such that the file is only imported if the colorpicker is going to be rendered. And taking an additional step back, we also need to ensure that our module's <code>js</code> and <code>css</code> directories are registered with the application when necessary. Otherwise our import won't work.</p>
<p>In the <a class="el" href="module_developer_guide_javascript.html#module_developer_guide_dataface_javascripttool">previous section</a> we used <a class="el" href="class_dataface___javascript_tool.html#a28f130070d771ecaccdbfcbd846db44e">Dataface_JavascriptTool::addPath()</a> method to register our <code>js</code> directory. However we only did this inside the <code>hello_world</code> action. This code is only executed for that one action and won't be executed for the <code>edit</code> form or other Xataface actions that may require the colorpicker widget to be rendered. A simple solution would be to perform this registration inside our module's constructor, but then we may be adding unnecessary overhead to our application since most of the application has no need for our scripts.</p>
<p>To succinctly rephrase, our problem is:</p>
<ol type="1">
<li>We want our Javascript files to be available to the <a class="el" href="class_dataface___javascript_tool.html" title="A Class that manages, builds, and maintains dependencies of javacripts.">Dataface_JavascriptTool</a> when they are needed and only when they are needed. (I.e. we don't want to load them if they are not needed as it adds to the overhead of the application).</li>
</ol>
<p>Properties of the ideal solution to this problem are outlined in the wording of the problem itself. Namely, the ideal solution should:</p>
<ol type="1">
<li>Make the CSS and Javascript files available to any part of the application that requires them.</li>
<li>Not load the CSS or Javascript files nor register the <code>css</code> or <code>Javascript</code> directories with <a class="el" href="class_dataface___javascript_tool.html" title="A Class that manages, builds, and maintains dependencies of javacripts.">Dataface_JavascriptTool</a> unless they are needed.</li>
</ol>
<p>To achieve this goal we will encapsulate the code that registers these files into our module's class as a method, and use a flag to ensure that they are loaded at most once.</p>
<p><code>hello_world.php:</code> </p>
<div class="fragment"><div class="line">&lt;?php</div>
<div class="line"><span class="keyword">class </span>modules_hello_world {</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// ... Other contents of this class hidden here ......</span></div>
<div class="line">        </div>
<div class="line">        <span class="keyword">private</span> $jsLoaded = <span class="keyword">false</span>;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Function to register the module&#39;s javascript and css</span></div>
<div class="line">        <span class="comment">// files</span></div>
<div class="line">        <span class="keyword">function</span> loadJs(){</div>
<div class="line">            <span class="keywordflow">if</span> ( !$this-&gt;jsLoaded ){</div>
<div class="line">                $this-&gt;jsLoaded = <span class="keyword">true</span>;</div>
<div class="line">                </div>
<div class="line">                $jsTool = <a class="code" href="class_dataface___javascript_tool.html#a8bc471b19f24aea65a4b5c1466c81937">Dataface_JavascriptTool::getInstance</a>();</div>
<div class="line">                $jsTool-&gt;addPath(</div>
<div class="line">                    dirname(__FILE__).<span class="stringliteral">&#39;/js&#39;</span>, </div>
<div class="line">                    DATAFACE_SITE_URL.<span class="stringliteral">&#39;/modules/hello_world/js&#39;</span></div>
<div class="line">                );</div>
<div class="line">                </div>
<div class="line">                $cssTool = <a class="code" href="class_dataface___c_s_s_tool.html#ac93fbec81f07e5d15f80db907e63dc10">Dataface_CSSTool::getInstance</a>();</div>
<div class="line">                $cssTool-&gt;addPath(</div>
<div class="line">                    dirname(__FILE__).<span class="stringliteral">&#39;/css&#39;</span>,</div>
<div class="line">                    DATAFACE_SITE_URL.<span class="stringliteral">&#39;/modules/hello_world/css&#39;</span></div>
<div class="line">                );</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Having this functionality encapsulated in a single method of our module makes it a simple matter to register the module's javascript and css assets on demand.</p>
<dl class="section note"><dt>Note</dt><dd>You can always access the module file using <a class="el" href="class_dataface___module_tool.html#abb420365e74bed94844dbd5f7dda904c">Dataface_ModuleTool::loadModule()</a> e.g.<div class="fragment"><div class="line">$mod = <a class="code" href="class_dataface___module_tool.html#a940c46dff92c1704a1d43d2926a72ba0">Dataface_ModuleTool::getInstance</a>()-&gt;loadModule(<span class="stringliteral">&#39;modules_hello_world&#39;</span>);</div>
<div class="line">$mod-&gt;loadJs();</div>
</div><!-- fragment --></dd></dl>
<p>Now to complete our solution, let's add load our bootstrap javascript code from our widget handler (hello_world_widget.js): </p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Dataface_FormTool_colorpicker {</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Builds a widget for the given record</span></div>
<div class="line">        <span class="keyword">function</span> buildWidget($record, &amp;<a class="code" href="blob_8php.html#a83e4d6721f3491a4fd780dbd3ce1a3c0">$field</a>, $form, $formFieldName, $new=<span class="keyword">false</span>){</div>
<div class="line">                </div>
<div class="line">            <span class="comment">// Obtain an HTML_QuickForm factory to creat the basic elements</span></div>
<div class="line">            $factory = <a class="code" href="class_dataface___form_tool.html#a47f02f15b11d4491e056298910e4204a" title="Returns a QuickForm object that can be used to generate elements safely.">Dataface_FormTool::factory</a>();</div>
<div class="line">            </div>
<div class="line">            $atts = array(</div>
<div class="line">                <span class="stringliteral">&#39;class&#39;</span> =&gt; <span class="stringliteral">&#39;xf-colorpicker&#39;</span></div>
<div class="line">            );</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Create a basic text field</span></div>
<div class="line">            $el = $factory-&gt;addElement(<span class="stringliteral">&#39;text&#39;</span>, $formFieldName, $widget[<span class="stringliteral">&#39;label&#39;</span>], $atts);</div>
<div class="line">            </div>
<div class="line">            <span class="comment">// Load our bootstrap colorpicker javascript code so that it runs</span></div>
<div class="line">            <span class="comment">// on page load.</span></div>
<div class="line">            $mod = <a class="code" href="class_dataface___module_tool.html#a940c46dff92c1704a1d43d2926a72ba0">Dataface_ModuleTool::getInstance</a>()-&gt;loadModule(<span class="stringliteral">&#39;modules_hello_world&#39;</span>);</div>
<div class="line">            $mod-&gt;loadJs();</div>
<div class="line">            <a class="code" href="class_dataface___javascript_tool.html#a8bc471b19f24aea65a4b5c1466c81937">Dataface_JavascriptTool::getInstance</a>()-&gt;import(</div>
<div class="line">                <span class="stringliteral">&#39;xataface/modules/hello_world/colorpicker_widget.js&#39;</span></div>
<div class="line">            );</div>
<div class="line">            </div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">return</span> $el;</div>
<div class="line">        }</div>
<div class="line">}</div>
</div><!-- fragment --><p>All we've done here is to call our loadJs() method on the hello_world module class to load our javascript and css directories. Then we imported the bootstrap code so that it will run on page load. Notice that we do all this inside the buildWidget() method of our widget handler. This ensures that it will only run the bootstrap code if a colorpicker widget has been built (and thus likely will exist on the final page output).</p>
<h1><a class="anchor" id="module_developer_guide_widget_step7"></a>
Step 7: Trying Out Our Widget</h1>
<p>Now if you reload the new record form for the <code>color_profile</code> table and click on one of the colorpicker fields, you should see something like:</p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-29_at_1.39.12_PM.png?max_width=640" />
</div>
<p>If you don't see anything like this, there see module_developer_guide_widget_troublueshooting</p>
<h1><a class="anchor" id="module_developer_guide_widget_troubleshooting"></a>
Troubleshooting</h1>
<p>If you run into problems along the way in this tutorial it really helps to have a good Javascript development tool so that you can easily check things like attributes and classes on HTML elements on the page. In addition you will want to keep an eye on the Javascript error log to see if any errors are reported. Especially in a tutorial such as this, with multiple parts, there are many places where you can go wrong. If a file is miss-named you may not see an error message - but the file will just not be picked up at all.</p>
<p>If you get really stuck, the best thing to do is seek help in the <a href="http://xataface.com/forum">forum</a>.</p>
<h1><a class="anchor" id="module_developer_guide_widget_download"></a>
Download This Module</h1>
<p>You can download the source for this module <a href="http://xataface.com/dox/core/examples/module_developer_guide/hello_world.create-custom-widget.tar.gz">here</a>.</p>
<ul>
<li>Return to <a class="el" href="module_developer_guide.html">Module Developer's Guide</a></li>
<li>Back to <a class="el" href="module_developer_guide_css.html">Adding Custom CSS Files</a></li>
<li>Next: <a class="el" href="module_developer_guide_withdata.html">Module-Associated Data</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon May 5 2014 09:52:19 for Xataface by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
