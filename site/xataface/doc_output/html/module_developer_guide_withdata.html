<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>Xataface: Module-Associated Data</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="xataface-logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Xataface
   &#160;<span id="projectnumber">2.0alpha2</span>
   </div>
   <div id="projectbrief">Xataface Application Framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Module-Associated Data </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>Return to <a class="el" href="module_developer_guide.html">Module Developer's Guide</a></li>
<li>Previous: <a class="el" href="module_developer_guide_widget.html">Creating Custom Widgets</a></li>
</ul>
<dl class="section user"><dt>Contents:</dt><dd><ol type="1">
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step1">Step 1: Create Database Structure</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step2">Step 2: Add Link to UI</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step3">Step 3: The fields.ini file</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step4">Step 4: The Table Delegate Class</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step5">Step 5: Permissions</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step6">Step 6: Details</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step7">Step 7: Packaging and Versioning</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step8">Step 8: Distributing Your Module</a></li>
<li><a class="el" href="module_developer_guide_withdata.html#module_developer_guide_withdata_step9">Download The Module Source</a></li>
</ol>
</dd></dl>
<p>So far we have created a module that has included:</p>
<ul>
<li><a class="el" href="module_developer_guide_first_module.html">A slot</a></li>
<li><a class="el" href="module_developer_guide_actions.html">An action</a></li>
<li>Custom Javascript</li>
<li><a class="el" href="module_developer_guide_css.html">Custom Stylesheets</a></li>
<li><a class="el" href="module_developer_guide_widget.html">A Custom Widget</a></li>
</ul>
<p>None of these examples included any module-associated data. In this section we will extend the "hello_world" module to include a blog component. This will require us to introduce some database tables that are associated with the module.</p>
<h1><a class="anchor" id="module_developer_guide_withdata_req"></a>
Module Requirements</h1>
<ol type="1">
<li>Should add an action to the "Table Links" to access the blog.</li>
<li>All config files and delegate classes for the blog should be included inside the module.</li>
<li>Should define slots that can be included in templates to show the 5 most recent blog posts.</li>
</ol>
<h1><a class="anchor" id="module_developer_guide_withdata_step1"></a>
Step 1: Create Database Structure</h1>
<p>The data structure for this blog will be very basic: a single table. We'll call this table: <code>xf_blog_posts</code> </p>
<p>It's definition is:</p>
<div class="fragment"><div class="line">create table xf_blog_posts (</div>
<div class="line">    blog_post_id <span class="keywordtype">int</span>(11) not null auto_increment primary key,</div>
<div class="line">    post_title varchar(255) not null,</div>
<div class="line">    post_content longtext,</div>
<div class="line">    date_posted datetime,</div>
<div class="line">    last_modified datetime,</div>
<div class="line">    posted_by varchar(100)</div>
<div class="line">)</div>
</div><!-- fragment --><p>Create this table in your application's database.</p>
<dl class="section note"><dt>Note</dt><dd>In a later section we'll see how to have this table automatically created when the module is activated. For now (testing purposes) we'll just create the table in our application's database so that we can work with it.</dd></dl>
<h1><a class="anchor" id="module_developer_guide_withdata_step2"></a>
Step 2: Add Link to UI</h1>
<p>In order for users to access the blog we need them to add a link to the xf_blog_posts table in their application. There are two ways to achieve this:</p>
<ol type="1">
<li>Instruct module users to add the link themselves in the conf.ini file</li>
<li>Have the module automatically add an action in the appropriate category to appear in the UI.</li>
</ol>
<p>We're going to take the second approach here. We want our module to appear along with the links to all of the tables at the top of the page.</p>
<dl class="section note"><dt>Note</dt><dd>This example requires the new Xataface 2.0 look and feel to be enabled (i.e. the <code>g2</code> module). This is because that module allows us to add links to the top left by way of the actions.ini files. The 1.0 look doesn't allow this for that part of the UI.</dd></dl>
<dl class="section user"><dt>Create actions.ini file</dt><dd>First create an actions.ini file for the module with the following contents:<div class="fragment"><div class="line">[blog]</div>
<div class="line">   label=<span class="stringliteral">&quot;Blog&quot;</span></div>
<div class="line">   url=<span class="stringliteral">&quot;{$site_href}?-table=xf_blog_posts&quot;</span></div>
<div class="line">   category=<span class="stringliteral">&quot;top_left_menu_bar&quot;</span></div>
<div class="line">   order=10</div>
<div class="line">   selected_condition=<span class="stringliteral">&quot;$query[&#39;-table&#39;] == &#39;xf_blog_posts&#39;&quot;</span></div>
</div><!-- fragment --></dd></dl>
<dl class="section note"><dt>Note</dt><dd>For more information about the actions.ini file and action syntax, see <a href="http://xataface.com/wiki/actions.ini_file">actions.ini file</a>.</dd></dl>
<dl class="section user"><dt>Make sure that the g2 module is installed and enabled</dt><dd>In the conf.ini file, make sure the g2 module is enabled as this is required for the top_left_menu_bar category to have any meaning:<div class="fragment"><div class="line">[_modules]</div>
<div class="line">    modules_g2=modules/g2/g2.php</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>Try it out:</dt><dd><div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-30_at_10.05.34_AM.png?max_width=640" />
</div>
</dd></dl>
<dl class="section user"><dt>New Post</dt><dd><div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-30_at_10.05.42_AM.png?max_width=640" />
</div>
</dd></dl>
<dl class="section user"><dt>Summary So Far</dt><dd>We have now created a module that uses a table and we have successfully linked our table into the application's menu so that it is accessible by users of the system. This is not very useful yet, however, as we haven't yet introduced a way to package this database structure into the module to that it can be ported to other applications. In addition we need to add some configuration for our blog so that, for example, the <code>date_posted</code>, <code>last_modified</code>, and <code>posted_by</code> fields get populated automatically.</dd></dl>
<h1><a class="anchor" id="module_developer_guide_withdata_step3"></a>
Step 3: The fields.ini file</h1>
<p>In order to configure our table, we need to define a fields.ini file. The normal location of a fields.ini file for a table would be at <code>APPLICATION_PATH%/tables/xf_blog_posts/fields</code>.ini but we want this configuration to be packaged with our module, so instead we'll place it at:</p>
<div class="fragment"><div class="line">%APPLICATION_PATH%/modules/hello_world/tables/xf_blog_posts/fields.ini</div>
</div><!-- fragment --><p>Our basic fields.ini file will contain:</p>
<div class="fragment"><div class="line">[date_posted]</div>
<div class="line">        widget:type=hidden</div>
<div class="line">        timestamp=insert</div>
<div class="line">        </div>
<div class="line">[last_modified]</div>
<div class="line">        widget:type=hidden</div>
<div class="line">        timestamp=update</div>
<div class="line">        </div>
<div class="line">[posted_by]</div>
<div class="line">        widget:type=hidden</div>
</div><!-- fragment --><dl class="section user"><dt>Tell Xataface Where The fields.ini File Is</dt><dd>We need to do one more thing in order to tell Xataface that it should look in our module directory for the fields.ini file instead of the usual location. Add the following to the constructor of our module class (i.e. <code>hello_world.php</code>):<div class="fragment"><div class="line"><a class="code" href="class_dataface___table.html#a2cc6873e75ff773816de1b8429d73e63">Dataface_Table::setBasePath</a>(<span class="stringliteral">&#39;xf_blog_posts&#39;</span>, dirname(__FILE__));</div>
</div><!-- fragment --> What this does is tell Xataface that the base path for the <code>xf_blog_posts</code> table is our hello world module so it will look for the "tables" directory with the fields.ini file etc.. inside our module's directory - at least when it is looking for config for the <code>xf_blog_posts</code> table.</dd></dl>
<p>Now the new record form for the xf_blog_posts table should look like: </p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-30_at_10.28.38_AM.png?max_width=640" />
</div>
<p>Notice that the <code>date_posted</code>, <code>last_modified</code>, and <code>posted_by</code> fields are now hidden. We've specified the <code>date_posted</code> and <code>last_modified</code> fields to be automatically populated with the appropriate timestamps (using the <code>timestamp</code> directive in the fields.ini file), but we still need to add some logic to populate the <code>posted_by</code> field. We will do this by implementing the <a class="el" href="group__delegate_class.html#ga7adcc68e0378d79732320139ed7f0cf8" title="Trigger called before a record is inserted into the database for the first time.">DelegateClass::beforeInsert()</a> method.</p>
<h1><a class="anchor" id="module_developer_guide_withdata_step4"></a>
Step 4: The Table Delegate Class</h1>
<p>Our table delegate class will be located at: </p>
<div class="fragment"><div class="line">%APPLICATION_PATH%/modules/hello_world/tables/xf_blog_posts/xf_blog_posts.php</div>
</div><!-- fragment --><p>The contents will start with:</p>
<div class="fragment"><div class="line">&lt;?php</div>
<div class="line"><span class="keyword">class </span>tables_xf_blog_posts {</div>
<div class="line">    <span class="keyword">function</span> beforeInsert($record){</div>
<div class="line">        <span class="keywordflow">if</span> ( class_exists(<span class="stringliteral">&#39;Dataface_AuthenticationTool&#39;</span>) ){</div>
<div class="line">            $record-&gt;setValue(</div>
<div class="line">                <span class="stringliteral">&#39;posted_by&#39;</span>, <a class="code" href="class_dataface___authentication_tool.html#a70344e265a1689f4ef67ce1bc5d889df">Dataface_AuthenticationTool::getInstance</a>()-&gt;getLoggedInUserName()</div>
<div class="line">            );</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>We check that the <a class="el" href="class_dataface___authentication_tool.html">Dataface_AuthenticationTool</a> class exists before trying to call any methods on it. This is because if the application doesn't implement authentication, then it may not have loaded the Authentication Tool - and we want this module to be portable.</dd></dl>
<p>Now if you insert a new post then look at the post in the database you should see the username of the currently logged in user reflected accurately.</p>
<h1><a class="anchor" id="module_developer_guide_withdata_step5"></a>
Step 5: Permissions</h1>
<p>So far we have completely ignored permissions. I.e. How do we decide which users can post blog posts or which blog posts they can view, edit, or delete. This can be a somewhat complex problem because when developing a module you often don't have any knowlege of how the user accounts and permissions will be managed in the application in which the module will be eventually installed.</p>
<p>If we were developing a blog application we would implement permissions simply by implementing a <a class="el" href="group__delegate_class.html#gaac1919008579685f034fc99be68a564c" title="Returns associative array of permissions that should be granted to the current user on this record...">DelegateClass::getPermissions()</a> or <a class="el" href="group__delegate_class.html#ga28e7d8521c6d7dc6254e4101e5e170a8" title="Returns one or more roles that are to be granted to the current user for the specified record...">DelegateClass::getRoles()</a> method where we would grant permissions based on factors such as the user's role, or who owns the post. In our case we have no knowledge of how the end application may define its roles so we can't reference them directly from a <a class="el" href="group__delegate_class.html#gaac1919008579685f034fc99be68a564c" title="Returns associative array of permissions that should be granted to the current user on this record...">DelegateClass::getPermissions()</a> method inside our module.</p>
<p>There are many strategies that we can employ for infusing our blog module with permissions. Some of these include:</p>
<ol type="1">
<li>Define a simple, rigid permissions system that doesn't depend on anything outside the module (e.g. we could allow all users to view blog posts, all logged-in users to post new blog posts, and allow only the post owner to edit or delete a post (we know this information from the <code>posted_by</code> field).</li>
<li>Defer permissions wholely to the application allowing them to implement their own getPermissions() method for the table.</li>
<li>Add some permissions (via the permissions.ini file) that are strictly for use with the blog module and allow the application to grant these permissions in its <a class="el" href="interface_application_delegate_class.html#aac1919008579685f034fc99be68a564c" title="Returns associative array of permissions that should be granted to the current user on the specified ...">ApplicationDelegateClass::getPermissions()</a> method... then our module could check those permissions in our own getPermissions() method where we would translate them into standard permissions for the xf_blog_posts table. (This sounds complex, but really its not).</li>
<li>Implement a hybrid of the above approaches.</li>
</ol>
<p>For this tutorial we are going to implement a hybrid of option #1 and option #2 above. We will implement #1 as the default functionality, and we will allow the application developer to define its own permissions method (option #2) if they want a more complex structure.</p>
<h2><a class="anchor" id="module_developer_guide_withdata_step5p1"></a>
Default Permissions</h2>
<p>For our default permissions system, we'll just have 3 levels of users, and we'll create corresponding roles for them in the module's permissions.ini file.</p>
<ol type="1">
<li>BLOG PUBLIC USER - A read only role</li>
<li>BLOG REGISTERED USER - Allows reading and posting new posts.</li>
<li>BLOG POST OWNER - Allows reading and posting, and editing. This role is assigned based on the <code>posted_by</code> field.</li>
</ol>
<dl class="section user"><dt>Create the permissions.ini file</dt><dd>We create a permissions.ini file in our module's directory with the following contents:<div class="fragment"><div class="line">[BLOG PUBLIC USER extends READ ONLY]</div>
<div class="line">[BLOG REGISTERED USER extends BLOG PUBLIC USER]</div>
<div class="line">    <span class="keyword">new</span>=1</div>
<div class="line">[BLOG POST OWNER extends BLOG REGISTERED USER]</div>
<div class="line">    edit=1</div>
<div class="line">    <span class="keyword">delete</span>=1</div>
</div><!-- fragment --></dd></dl>
<dl class="section user"><dt>create the getRoles() method:</dt><dd>Now in our <code>xf_blog_posts</code> delegate class we add the following <a class="el" href="group__delegate_class.html#ga28e7d8521c6d7dc6254e4101e5e170a8" title="Returns one or more roles that are to be granted to the current user for the specified record...">DelegateClass::getRoles()</a> implementation:<div class="fragment"><div class="line"><span class="keyword">function</span> getRoles($record){</div>
<div class="line">    $username = <a class="code" href="class_dataface___authentication_tool.html#a70344e265a1689f4ef67ce1bc5d889df">Dataface_AuthenticationTool::getInstance</a>()-&gt;getLoggedInUserName();</div>
<div class="line">    <span class="keywordflow">if</span> ( $record and $username and $record-&gt;val(<span class="stringliteral">&#39;posted_by&#39;</span>) == $username ){</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&#39;BLOG POST OWNER&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( $username ){</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&#39;BLOG REGISTERED USER&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&#39;BLOG PUBLIC USER&#39;</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></dd></dl>
<p>Now if you try out your application with different user accounts, logged in or no, you should notice that:</p>
<ul>
<li>If not logged in, you can view all of the blog posts but can't edit them, or post new posts.</li>
<li>If logged in, you can post new blog posts but can only edit posts that were posted by you.</li>
</ul>
<h2><a class="anchor" id="module_developer_guide_withdata_step5p2"></a>
Allowing Application to Override Permissions</h2>
<p>The default permissions that we set up seem logical, but one inescapable fact of life is that there is no such thing as one-size-fits-all. In order for this module to be truly useful to application developers, they need to be able to override the permissions to fit their own needs. We will allow them to do this by leveraging the <a class="el" href="group__delegate_class.html#ga3b7aba53c000ea43b849f1da33e2dc25" title="Returns an alternate object to be used as the delegate. This is handy for module developers to allow ...">DelegateClass::getDelegate()</a> method to return an alternate delegate class at our discretion.</p>
<p>Our <a class="el" href="group__delegate_class.html#ga3b7aba53c000ea43b849f1da33e2dc25" title="Returns an alternate object to be used as the delegate. This is handy for module developers to allow ...">DelegateClass::getDelegate()</a> method will check the application's tables/xf_blog_posts directory to see if they have defined their own delegate class. If so we'll return an instance of that object. Otherwise it just returns null to indicate that our delegate will remain in the authority.</p>
<dl class="section note"><dt>Note</dt><dd>If we allow the application to implment their own delegate class it is a good idea to recommend that their class extends from our class so that they can still take advantage of the other customizations that have been defined in our delegate class (e.g. the <a class="el" href="group__delegate_class.html#ga7adcc68e0378d79732320139ed7f0cf8" title="Trigger called before a record is inserted into the database for the first time.">DelegateClass::beforeInsert()</a> trigger).</dd></dl>
<dl class="section attention"><dt>Attention</dt><dd>Watch out for name conflicts in the delegate class. The application's delegate class cannot have the same name as our delegate class so it is best to direct users to employ a slightly different name for their application delegate class.</dd></dl>
<dl class="section user"><dt>Our getDelegate() method: </dt><dd><div class="fragment"><div class="line"><span class="keyword">function</span> getDelegate(){</div>
<div class="line">        $altpath = DATAFACE_SITE_PATH.<span class="stringliteral">&#39;/tables/xf_blog_posts/xf_blog_posts.php&#39;</span>;</div>
<div class="line">        <span class="keywordflow">if</span> ( is_readable($altpath) ){</div>
<div class="line">                include $altpath;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> ( class_exists(<span class="stringliteral">&#39;tables_xf_blog_posts_override&#39;</span>) ){</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">new</span> xb_blog_posts_override;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> null;</div>
<div class="line">}</div>
</div><!-- fragment --></dd></dl>
<dl class="section note"><dt>Note</dt><dd>In this example we are requiring application developers to name their optional delegate class <code>xb_blog_posts_override</code>. Make sure that you include this in your documentation so that application developers know how to extend your module.</dd></dl>
<p>An example overriding delegate class might look like:</p>
<div class="fragment"><div class="line">&lt;?php</div>
<div class="line"><span class="keyword">class </span>tables_xf_blog_posts_override <span class="keyword">extends</span> tables_xf_blog_posts {</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">public</span> <span class="keyword">function</span> getRoles($record){</div>
<div class="line">        $user = <a class="code" href="class_dataface___authentication_tool.html#a70344e265a1689f4ef67ce1bc5d889df">Dataface_AuthenticationTool::getInstance</a>()-&gt;getLoggedInUser();</div>
<div class="line">        <span class="keywordflow">if</span> ( $user and $user-&gt;val(<span class="stringliteral">&#39;role&#39;</span>) == <span class="stringliteral">&#39;ADMIN&#39;</span> ){</div>
<div class="line">                <span class="comment">// Admin users should just use the permissions defined in</span></div>
<div class="line">                <span class="comment">// the applicaiton delegate class (all perms usually)</span></div>
<div class="line">                <span class="keywordflow">return</span> null;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="keywordflow">return</span> parent::getRoles($record);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section attention"><dt>Attention</dt><dd>It is important that the override delegate class attempt to use the default behavior of the module's parent delegate class whenever possible to ensure that it isn't overriding essential behavior. E.g. the beforeInsert() method of the module's delegate class performs important functions that need to be run regardless of whether the application wants to override it. It is best practice in these cases to check if the parent method exists and try to call it where appropriate inside the child. E.g.:<div class="fragment"><div class="line"><span class="keyword">function</span> beforeInsert($record){</div>
<div class="line">    <span class="keywordflow">if</span> ( method_exists(<span class="stringliteral">&#39;tables_xf_blog_posts&#39;</span>, <span class="stringliteral">&#39;beforeInsert&#39;</span>) ){</div>
<div class="line">        $res = parent::beforeInsert($record);</div>
<div class="line">        <span class="keywordflow">if</span> ( <a class="code" href="class_p_e_a_r.html#ae59587d5f701115ff0ae38bd852789db">PEAR::isError</a>($res) ) <span class="keywordflow">return</span> $res;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Now do custom stuff</span></div>
<div class="line">}</div>
</div><!-- fragment --></dd></dl>
<h1><a class="anchor" id="module_developer_guide_withdata_step6"></a>
Step 6: Details</h1>
<p>Before moving onto the final steps of packaging our module, there is one nagging thing that we should really polish up: The label for our table. The "New Record" button says "New xf_blog_post". This is really ugly. Let's change it to "Blog Posts" using the global <code>label</code> directive of the fields.ini <a href="file:@code">file:@code</a> label="Blog Posts" </p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-30_at_11.38.45_AM.png?max_width=640" />
</div>
<p>Ahh.. much better.</p>
<h1><a class="anchor" id="module_developer_guide_withdata_step7"></a>
Step 7: Packaging and Versioning</h1>
<p>If we were to distribute our module at this point, we would need to include directions on how to build the xf_blog_posts MySQL table manually. What if we improve our module later on and want to distribute the changes? We would need to again direct our users to modify their xf_blog_posts table to correspond with our changes. This is inconvenient and error-prone. Thankfully, Xataface offers a better way with its packaging and versioning features.</p>
<dl class="section user"><dt>Create the version.txt File:</dt><dd>All Xataface modules should include a plain text file named <code>version.txt</code> that marks the version number of the module. This file follows the same format as the Xataface <code>version.txt</code> <a href="file:@code">file:@code</a> x.y.z w  Where <code>x.y.z</code> is the human-readable version number (e.g. 1.3.1) and <code>w</code> is the ever-incrementing build number (e.g. 1256). Every time you release a new version you should increment this number so that Xataface can tell that the file system version of your module is newer than the version currently in the database.</dd></dl>
<p>We'll start our module at version <code>0.1</code> (human-readable) and with a build number <code>1</code>. So our version.txt file will look like:</p>
<div class="fragment"><div class="line">0.1 1</div>
</div><!-- fragment --><h2><a class="anchor" id="module_developer_guide_withdata_step8_installer"></a>
The installer.php file</h2>
<p>Now that we have a means to marking the file system version of our module, let's create the <code>installer.php</code> file to tell Xataface what it has to do to bring the database inline with the current file system version. Our initial installer.php file will be located in the root of the module's directory (i.e. <code>APPLICATION_PATH%/modules/hello_world/installer</code>.php, and it will contain the following:</p>
<div class="fragment"><div class="line">&lt;?php</div>
<div class="line"><span class="keyword">class </span>modules_hello_world_installer {</div>
<div class="line">    <span class="keyword">function</span> update_1(){</div>
<div class="line">    </div>
<div class="line">        $sql[] = <span class="stringliteral">&quot;create table if not exists xf_blog_posts (</span></div>
<div class="line"><span class="stringliteral">                                        blog_post_id int(11) not null auto_increment primary key,</span></div>
<div class="line"><span class="stringliteral">                                        post_title varchar(255) not null,</span></div>
<div class="line"><span class="stringliteral">                                        post_content longtext,</span></div>
<div class="line"><span class="stringliteral">                                        date_posted datetime,</span></div>
<div class="line"><span class="stringliteral">                                        last_modified datetime,</span></div>
<div class="line"><span class="stringliteral">                                        posted_by varchar(100)</span></div>
<div class="line"><span class="stringliteral">                                )&quot;</span>;</div>
<div class="line">                                </div>
<div class="line">                df_q($sql);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>Things to notice:</p>
<ol type="1">
<li>The class name follows the naming convention <code>modules_modulename_installer</code>.</li>
<li>The method <code>update_1()</code> will be executed by Xataface in the event that the database version of the module is lower than 1 and the file system version is greater than or equal to 1. This conveniently serves as an install script for your module since the first time your module is activated, the database version is effectively 0, so the update_1() method would be called to create the xf_blog_posts table.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd>Xataface stores the database module version numbers in a table called <code>dataface__modules</code>. If you need to clear the database version number or play with it for development purposes, you can modify the record corresponding to your module in this table.</dd></dl>
<dl class="section see"><dt>See Also</dt><dd><a href="http://www.sjhannah.com/blog/?p=144">Application Versioning and Synchronization with Xataface</a> for a full discussion of Xataface's versioning and synchronization features.</dd></dl>
<dl class="section user"><dt>Starting Fresh</dt><dd>Let's try out our packaging and versioning by deleting the xf_blog_posts table from our database, and also deleting the corresponding entry in the <code>dataface__modules</code> table. Then load the application in your browser again.</dd></dl>
<p>If everything went as planned you should see no difference in your application. If you check the database, your <code>xf_blog_posts</code> table has been recreated and the dataface__modules table now has an entry for your module marking it with version 1: </p>
<div class="image">
<img src="http://media.weblite.ca/files/photos/Screen_shot_2011-11-30_at_12.00.50_PM.png?max_width=640" />
</div>
<h1><a class="anchor" id="module_developer_guide_withdata_step8"></a>
Step 8: Distributing Your Module</h1>
<p>Now that the module has a self-contained installer you should be able to package it up and distribute it. Installing the module in a different application is as simple as adding and entry to the <code></code>[_modules] section of the conf.ini file. If you do distribute your module, make sure to include documentation so that people know how to use it. Also be sure to let the rest of us know about your module on the <a href="http://xataface.com/forum">Xataface forum</a>.</p>
<h1><a class="anchor" id="module_developer_guide_withdata_step9"></a>
Download The Module Source</h1>
<p>You can download the source for this module <a href="http://xataface.com/dox/core/examples/module_developer_guide/hello_world.with-data.tar.gz">here</a>.</p>
<ul>
<li>Return to <a class="el" href="module_developer_guide.html">Module Developer's Guide</a></li>
<li>Previous: <a class="el" href="module_developer_guide_widget.html">Creating Custom Widgets</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon May 5 2014 09:52:19 for Xataface by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.3.1
</small></address>
</body>
</html>
